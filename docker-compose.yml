version: '3'
services:
  web:
    build:
      context:              .                    #cannot have ./nginx here b/c some dirs would be outside of context for Dockerfile
      dockerfile:           Dockerfile_nginx     #./nginx/Dockerfile doesn't work for the context reason mentioned  above
    image:                  testweb_web:test
    ports:
      - 0.0.0.0:80:80
      - 0.0.0.0:81:81                            #Status stub port for datadog monitoring
    environment:
      NGINX_HOST:           ${YOUR_LOCAL_IP}     #Export Env before docker-compose
      NGINX_PORT:           80
      APP_HOST:             ${YOUR_LOCAL_IP}
      APP_PORT:             8000
  app:
    build:
      context:              .
    image:                  testweb_app:test
    ports: 
      - 0.0.0.0:8000:8000
    depends_on:
      - "db"                                     #Confirms that db container is up, but doesnt mean db service is up inside.
    environment:
      DEBUG:                "False"              #Must be "False" to get APM to work. Plus, not boolean, string
      DOCKPGHOST:           ${YOUR_LOCAL_IP}  
      DOCKPGPORT:           5432
      DOCKPGDB:             testweb
      DOCKPGUSER:           postgres
      DOCKPGPASSWD:         Test1Pass            #local usage only
      SECRET_KEY:           Example5ecretKey     #local usage only
      NEVERCACHE_KEY:       Example2evercacheKey #local usage only
      DD_APM_HOST:          ${YOUR_LOCAL_IP}
      DOCK_DEFAULT_GW:      ${DOCK_DEFAULT_GW}
  db:
    build:
      context:              .
      dockerfile:           Dockerfile_postgres
    image:                  testweb_db:9.6
    ports:
      - 0.0.0.0:5432:5432
    environment:
      POSTGRES_PASSWORD:    Test1Pass            #local usage only
      POSTGRES_DB:          testweb
      POSTGRES_USER:        postgres
      POSTGRES_INITDB_ARGS: --encoding=UTF-8 --locale=C
  datadog:
    build:
      context:              .
      dockerfile:           Dockerfile_datadog
    image:                  testweb_datadog:test
    ports:
     - 0.0.0.0:8126:8126/tcp
    links:
     - web                                       # ensures that nginx web is up for monitoring
     - app                                       # ensures that python app is up for monitoring
     - db                                        # ensures that postgres db is up for monitoring
    environment:
      DD_APM_ENABLED:       "true"
      DD_API_KEY:           ${DD_API_KEY}        #Export Env before docker-compose
      NGINX_HOST:           ${YOUR_LOCAL_IP}
      DB_HOST:              ${YOUR_LOCAL_IP}
      DD_HOST:              172.19.0.1
    volumes:
     - /var/run/docker.sock:/var/run/docker.sock
     - /proc/:/host/proc/:ro
     - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
